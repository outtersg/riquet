#!/bin/sh

DelieS() { local s2 ; while [ -h "$s" ] ; do s2="`readlink "$s"`" ; case "$s2" in [^/]*) s2="`dirname "$s"`/$s2" ;; esac ; s="$s2" ; done ; } ; SCRIPTS() { local s="`command -v "$0"`" ; [ -x "$s" -o ! -x "$0" ] || s="$0" ; case "$s" in */bin/*sh) case "`basename "$s"`" in *.*) true ;; *sh) s="$1" ;; esac ;; esac ; case "$s" in [^/]*) local d="`dirname "$s"`" ; s="`cd "$d" ; pwd`/`basename "$s"`" ;; esac ; DelieS ; s="`dirname "$s"`" ; DelieS ; SCRIPTS="$s" ; } ; SCRIPTS

R="`dirname "$SCRIPTS"`"
VAR="$R/var"
BDD="$VAR/riquet.sqlite3"

analyserParametres()
{
	where= cols=
	while [ $# -gt 0 ]
	do
		case "$1" in
			-t) cols="$cols||' '||nom" ;;
			/) where="desc regexp '$2' or comm regexp '$2'" ; shift ;;
			*) where="num in ('`echo "$*" | sed -e "s/ /','/g"`')" ;;
		esac
		shift
	done
}

param()
{
	local sql=0
	if [ "x$1" = x--sql ] ; then sql=1 ; shift ; fi
	php -r \
	"
		require '$R/etc/riquet.php';
		\$t = \$config['$1'];
		is_array(\$t) || \$t = array(\$t);
		function sql(\$c)
		{
			return \"'\".strtr(\$c, array(\"'\" => \"''\")).\"'\";
		}
		echo implode(',', $sql ? array_map('sql', \$t) : \$t);
	"
}

analyserParametres "$@"
sqlite3 "$BDD" "select '['||num||'|`param servicenow`/incident.do?sys_id='||id_ext||']'$cols from f where $where order by num desc;"
